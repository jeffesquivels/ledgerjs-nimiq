<html>
<head>
    <script src="nimiq.js"></script>
    <script src="ledgerjs-nimiq.js"></script>
    <script>

        const openTimeout = 3600000;
        const exchangeTimeout = 29 * 1000;
        let _api = null;
        let _appVersion = null;

        function getPublicKey(confirm) {
          let bip32Path = document.getElementById('bip32PathPK').value;
          return connect().then(function (api) {
            const msg = confirm ? 'Confirm public key...' : 'Getting public key...';
            displayStatus(msg);
//            disableControls(true);
            return api.getPublicKey(bip32Path, false, confirm).then((result) => {
              displayPublicKey(Nimiq.BufferUtils.toHex(result.publicKey));
              displayStatus('Received public key');
//              disableControls(false);
              return result.publicKey;
            }).catch((error) => {
              displayStatus('Failed to get public key: ' + error);
              throw error;
            });
          });
        }

        function getAddress(confirm) {
          let bip32Path = document.getElementById('bip32Path').value;
          return connect().then(function (api) {
            const msg = confirm ? 'Confirm address...' : 'Getting address...';
            displayStatus(msg);
//            disableControls(true);
            return api.getAddress(bip32Path, true, confirm).then((result) => {
              displayAddress(result.address);
              displayStatus('Received address');
//              disableControls(false);
              return result.address;
            }).catch((error) => {
              displayStatus('Failed to get address: ' + error);
              throw error;
            });
          });
        }

        function sign() {
          signTransaction(document.getElementById('hexTx').value);
        }

        function signTransaction(tx) {
          let buffer = Nimiq.BufferUtils.fromHex(tx);
            // getPublicKey(false).then((publicKey) => {
            //     displayStatus('Loading account data...');
            //     loadAccount(publicKey).then((account) => {
            //       const transaction = operation(account);
                  connect().then((api) => {
                    // StellarSdk.Network.useTestNetwork();
                    let bip32Path = document.getElementById('bip32Path').value;
                    displayStatus('Signing transaction...');
//                    disableControls(true);
                    api.signTransaction(bip32Path, buffer).then((result) => {
                      // const txHash = transaction.hash();
                      // const keyPair = StellarSdk.Keypair.fromPublicKey(publicKey);
                      // if (keyPair.verify(txHash, result.signature)) {
                      //   displayStatus('Transaction signed');
                      // } else {
                      //   displayStatus('Bad signature');
                      // }
                      displaySignature(Nimiq.BufferUtils.toHex(result.signature));
//                      disableControls(false);
                    }).catch(function (err) {
                      displayStatus(err);
                    });
                  });
            //     });
            // });
        }

        function open() {
          displayStatus('Opening');
          return LedgerjsNimiq.Transport.create(openTimeout).then((transport) => {
            transport.setDebugMode(true);
//            transport.setExchangeTimeout(exchangeTimeout);
            _api = new LedgerjsNimiq.Api(transport);
            displayStatus('Opened');
            return _api;
          }).catch((err) => {
            displayStatus('Error opening: ' + err);
          });
        }

        function connect() {
          if (_api === null) {
            return open().then((api) => {
              return api.getAppConfiguration().then((result) => {
                _appVersion = result.version;
                displayStatus('Connected (app version ' + _appVersion + ')');
                return api;
              });
            });
          } else {
            return _api.getAppConfiguration().then((result) => {
              _appVersion = result.version;
              displayStatus('Connected (app version ' + _appVersion + ')');
              return _api;
            }).catch((err) => {
              _api = null;
              console.log(err);
              return connect();
            });
          }
        }

        function displayStatus(msg) {
          console.log(msg);
          document.getElementById('status').innerHTML = msg;
        }

        function displayPublicKey(address) {
          document.getElementById('publicKey').innerHTML = address;
        }

        function displayAddress(address) {
          document.getElementById('address').innerHTML = address;
        }

        function displaySignature(signature) {
          document.getElementById('signature').innerHTML = signature;
        }

        function init() {
          connect().then(function () {
            disableControls(false);
          })
        }

        function disableControls(disable) {
          const inputs = document.getElementsByTagName('input');
          for(let i = 0; i < inputs.length; i++){
            inputs[i].disabled = disable;
          }
        }

    </script>
</head>
<body onload="init()">
<div>Status: <span id="status" style="font-family: monospace; font-size: 15px;"></span></div>
<div>&nbsp;</div>
<div id="connectForm">
    <input id='connect' type="button" onClick="connect()" value="Connect" disabled>
</div>
<div>&nbsp;</div>
<div id="publicKeyForm">
  <input type="text" id="bip32PathPK" value="44'/242'/0'/0'" disabled>
  <input id='getPublicKey' type="button" onClick="getPublicKey(false)" value="Get Public Key" disabled>
  <input id='confirmPublicKey' type="button" onClick="getPublicKey(true)" value="Confirm Public Key" disabled>
</div>
<div>&nbsp;</div>
<div>Public Key: <span id="publicKey" style="font-family: monospace; font-size: 15px;"></span></div>
-- <div>&nbsp;</div>
<div id="addressForm">
  <input type="text" id="bip32Path" value="44'/242'/0'/0'" disabled>
  <input id='getAddress' type="button" onClick="getAddress(false)" value="Get Address" disabled>
  <input id='confirmAddress' type="button" onClick="getAddress(true)" value="Confirm Address" disabled>
</div>
<div>&nbsp;</div>
<div>Address: <span id="address" style="font-family: monospace; font-size: 15px;"></span></div>
-- <div>&nbsp;</div>
<div id="form">
    <input type="text" id="hexTx" value="0000573dbdf6a7d83925ecf0ba0022a9a86c9be3c081008626c5378734e05d71cb4034eb97741909764e6e0000000000000f4240000000000000000a00000e790200">
    <input id='signTx' type="button" onClick="sign()" value="Sign" disabled>
</div>
<div>&nbsp;</div>
<div>Signature: <span id="signature" style="font-family: monospace; font-size: 15px;"></span></div>
</body>
</html>
